<template>
	<Dialog
		v-model="show"
		:options="{
			title: __('Write a Review'),
			size: 'xl',
			actions: [
				{
					label: 'Submit',
					variant: 'solid',
					onClick: (close) => submitReview(close),
				},
			],
		}"
	>
		<template #body-content>
			<div class="flex flex-col gap-4">
				<div>
					<div class="mb-1.5 text-sm text-gray-600">
						{{ __('Rating') }}
					</div>
					<Rating v-model="review.rating" :rating_from="rating_from" />
				</div>
				<div>
					<div class="mb-1.5 text-sm text-gray-600">
						{{ __('Review') }}
					</div>
					<Textarea :rows="5" v-model="review.review" />
				</div>
			</div>
		</template>
	</Dialog>
</template>
<script setup>
import { Dialog, Textarea, Rating, createResource } from 'frappe-ui'
import { defineModel, reactive, ref } from 'vue'
import { createToast } from '@/utils/'

const show = defineModel()
const reviews = defineModel('reloadReviews')
const hasReviewed = defineModel('hasReviewed')
const rating_from = ref(5)

let review = reactive({
	review: '',
	rating: 0,
})

const props = defineProps({
	courseName: {
		type: String,
		required: true,
	},
})

const createReview = createResource({
	url: 'frappe.client.insert',
	makeParams(values) {
		return {
			doc: {
				doctype: 'LMS Course Review',
				course: props.courseName,
				...values,
			},
		}
	},
})

const submitReview = (close) => {
	review.rating = review.rating / rating_from.value
	createReview.submit(review, {
		validate() {
			if (!review.rating) {
				return 'Please enter a rating.'
			}
		},
		onSuccess() {
			reviews.value.reload()
			hasReviewed.value.reload()
		},
		onError(err) {
			createToast({
				text: err.messages?.[0] || err,
				icon: 'x',
				iconClasses: 'text-red-600 bg-red-300',
			})
		},
	})
	close()
}
</script>
